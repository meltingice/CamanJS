/*!
 * CamanJS - Pure HTML5 Javascript (Ca)nvas (Man)ipulation
 * http://camanjs.com/
 *
 * Version 2.3
 *
 * Copyright 2011, Ryan LeFevre
 * Licensed under the new BSD License.
 * See LICENSE for more info.
 *
 * Project Contributors:
 *   Ryan LeFevre - Lead Developer and Project Maintainer
 *    Twitter: @meltingice
 *    GitHub: http://github.com/meltingice
 *
 *   Rick Waldron - Plugin Architect and Developer
 *    Twitter: @rwaldron
 *    GitHub: http://github.com/rwldrn
 *
 *   Cezar Sa Espinola - Developer
 *    Twitter: @cezarsa
 *    GitHub: http://github.com/cezarsa
 *//*global Caman: true *//*
 * Responsible for loading CamanJS and setting everything up.
 * The Caman() function is defined here.
 *//*global Caman: true */
(function(){"console"in window||(window.console={log:function(){},info:function(){},error:function(){}});var a=function(){if(arguments.length==1)return a.store[arguments[0]]?a.store[arguments[0]]:new a.manip.loadImage(arguments[0]);if(arguments.length==2){if(a.store[arguments[0]])return arguments[1].call(a.store[arguments[0]],a.store[arguments[0]]);if(typeof arguments[1]=="function"){var b=a.$(arguments[0]).nodeName.toLowerCase();if(b=="img")return new a.manip.loadImage(arguments[0],arguments[1]);if(b=="canvas")return new a.manip.loadCanvas(null,arguments[0],arguments[1])}else if(typeof arguments[1]=="string")return new a.manip.loadCanvas(arguments[0],arguments[1])}else if(arguments.length==3)return a.store[arguments[0]]?arguments[2].call(a.store[arguments[1]],a.store[arguments[1]]):new a.manip.loadCanvas(arguments[0],arguments[1],arguments[2])};a.version={release:"2.3",date:"7-5-2011"};var b=function(b,c,d){var e=this;this.pixelStack=[],this.layerStack=[],this.renderQueue=[],this.canvas=c,this.context=this.canvas.getContext("2d");if(b!==null){var f=b.height,g=b.width,h=b.getAttribute("data-camanwidth")||c.getAttribute("data-camanwidth"),i=b.getAttribute("data-camanheight")||c.getAttribute("data-camanheight");if(h||i)h?(b.width=parseInt(h,10),i?b.height=parseInt(i,10):b.height=b.width*f/g):i&&(b.height=parseInt(i,10),b.width=b.height*g/f);c.width=b.width,c.height=b.height,this.context.drawImage(b,0,0,b.width,b.height)}this.image_data=this.context.getImageData(0,0,c.width,c.height),this.pixel_data=this.image_data.data,this.dimensions={width:c.width,height:c.height},a.store[this.canvas_id]=this,d.call(this,this);return this};a.manip=a.prototype={loadImage:function(c,d){var e,f=this,g,h,i=function(){var e=document.createElement("canvas");if(a.$(c)===null||a.$(c).nodeName.toLowerCase()!=="img")throw"Given element ID isn't an image: "+c;e.id=g.id,g.getAttribute("data-camanwidth")&&e.setAttribute("data-camanwidth",g.getAttribute("data-camanwidth")),g.getAttribute("data-camanheight")&&e.setAttribute("data-camanheight",g.getAttribute("data-camanheight")),g.parentNode.replaceChild(e,g),this.canvas_id=c,this.options={canvas:c,image:g.src},b.call(f,g,e,d);return this};d=d||function(){};if(typeof c=="object"&&c.nodeName.toLowerCase()=="img"){var j=c;c.id?c=j.id:(c="caman-"+a.uniqid.get(),j.id=c)}e=a.$(c)!==null,e?(g=a.$(c),h=a.remoteCheck(g.src),h?(g.src=h,g.onload=function(){i.call(f)}):g.complete?i.call(this):g.onload=function(){i.call(f)}):document.addEventListener("DOMContentLoaded",function(){g=a.$(c),h=a.remoteCheck(g.src),h&&(g.src=h),g.onload=function(){i.call(f)}},!1);return this},loadCanvas:function(c,d,e){var f,g=this,h=function(){var f=a.$(d),h=document.createElement("img"),i=a.remoteCheck(c);if(a.$(d)===null||a.$(d).nodeName.toLowerCase()!=="canvas")throw"Given element ID isn't a canvas: "+d;c===null?b.call(g,null,f,e):(h.onload=function(){b.call(g,h,f,e)},i?h.src=i:h.src=c),this.canvas_id=d,this.options={canvas:d,image:h.src}};e=e||function(){};if(typeof d=="object"&&d.nodeName.toLowerCase()=="canvas"){var i=d;d.id?d=i.id:(d="caman-"+a.uniqid.get(),i.id=d)}f=a.$(d)!==null,f?h.call(this):document.addEventListener("DOMContentLoaded",function(){h.call(g)},!1);return this}},a.manip.loadImage.prototype=a.manip,a.manip.loadCanvas.prototype=a.manip,a.$=function(a){a[0]=="#"&&(a=a.substr(1));return document.getElementById(a)},a.store={},a.isRemote=function(a){var b=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/,c;if(!!a&&!!a.length){var d=a.match(b);if(d){c=d[1];return c!=document.domain}return!1}},a.remoteCheck=function(b){if(a.isRemote(b)){if(!a.remoteProxy.length){console.info("Attempting to load remote image without a configured proxy, URL: "+b);return}if(a.isRemote(a.remoteProxy)){console.info("Cannot use a remote proxy for loading remote images due to same-origin policy");return}return a.remoteProxy+"?url="+encodeURIComponent(b)}},window.Caman=a})(),function(a){var b=Array.prototype.forEach,c=Object.prototype.hasOwnProperty,d=Array.prototype.slice;a.plugin={},Function.prototype.bind||(Function.prototype.bind=function(a){var b=[].slice,c=b.call(arguments,1),d=this,e=function(){},f=function(){return d.apply(this instanceof e?this:a||{},c.concat(b.call(arguments)))};e.prototype=d.prototype,f.prototype=new e;return f}),a.toString=a.manip.toString=function(){return"Version "+a.version.release+", Released "+a.version.date},a.forEach=function(a,d,e){if(!a||!d)return{};e=e||this;if(b&&a.forEach===b)return a.forEach(d,e);for(var f in a)c.call(a,f)&&d.call(e,a[f],f,a);return a},a.extend=function(b){var c=b,e=d.call(arguments,1);a.forEach(e,function(a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b])});return c},a.clampRGB=function(a){if(a>255)return 255;if(a<0)return 0;return a},a.useProxy=function(a){var b={ruby:"rb",python:"py",perl:"pl"};a=b[a.toLowerCase()]||a.toLowerCase();return"proxies/caman_proxy."+a},a.uniqid=function(){var a=0;return{get:function(){return a++},reset:function(){a=0}}}(),a.extend(a,{sizeOf:function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b},sameAs:function(a,b){if(a.length!==b.length)return!1;for(var c=a.length;c>=0;c--)if(a[c]!==b[c])return!1;return!0},remove:function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++)a[d]!==b&&c.push(a[d]);a=c;return c},randomRange:function(a,b,c){var d=a+Math.random()*(b-a);return typeof c=="undefined"?Math.round(d):d.toFixed(c)},rgb_to_hsl:function(a,b,c){a/=255,b/=255,c/=255;var d=Math.max(a,b,c),e=Math.min(a,b,c),f,g,h=(d+e)/2;if(d==e)f=g=0;else{var i=d-e;g=h>.5?i/(2-d-e):i/(d+e);switch(d){case a:f=(b-c)/i+(b<c?6:0);break;case b:f=(c-a)/i+2;break;case c:f=(a-b)/i+4}f/=6}return{h:f,s:g,l:h}},hue_to_rgb:function(a,b,c){c<0&&(c+=1),c>1&&(c-=1);if(c<1/6)return a+(b-a)*6*c;if(c<.5)return b;if(c<2/3)return a+(b-a)*(2/3-c)*6;return a},hsl_to_rgb:function(a,b,c){var d,e,f;if(b===0)d=e=f=c;else{var g=c<.5?c*(1+b):c+b-c*b,h=2*c-g;d=this.hue_to_rgb(h,g,a+1/3),e=this.hue_to_rgb(h,g,a),f=this.hue_to_rgb(h,g,a-1/3)}return{r:d*255,g:e*255,b:f*255}},rgb_to_hsv:function(a,b,c){a=a/255,b=b/255,c=c/255;var d=Math.max(a,b,c),e=Math.min(a,b,c),f,g,h=d,i=d-e;g=d===0?0:i/d;if(d==e)f=0;else{switch(d){case a:f=(b-c)/i+(b<c?6:0);break;case b:f=(c-a)/i+2;break;case c:f=(a-b)/i+4}f/=6}return{h:f,s:g,v:h}},hsv_to_rgb:function(a,b,c){var d,e,f,g=Math.floor(a*6),h=a*6-g,i=c*(1-b),j=c*(1-h*b),k=c*(1-(1-h)*b);switch(g%6){case 0:d=c,e=k,f=i;break;case 1:d=j,e=c,f=i;break;case 2:d=i,e=c,f=k;break;case 3:d=i,e=j,f=c;break;case 4:d=k,e=i,f=c;break;case 5:d=c,e=i,f=j}return{r:d*255,g:e*255,b:f*255}},rgb_to_xyz:function(a,b,c){a=a/255,b=b/255,c=c/255,a>.04045?a=Math.pow((a+.055)/1.055,2.4):a=a/12.92,b>.04045?b=Math.pow((b+.055)/1.055,2.4):b=b/12.92,c>.04045?c=Math.pow((c+.055)/1.055,2.4):c=c/12.92;var d=a*.4124+b*.3576+c*.1805,e=a*.2126+b*.7152+c*.0722,f=a*.0193+b*.1192+c*.9505;return{x:d*100,y:e*100,z:f*100}},xyz_to_rgb:function(a,b,c){a=a/100,b=b/100,c=c/100;var d,e,f;d=3.2406*a+ -1.5372*b+ -0.4986*c,e=-0.9689*a+1.8758*b+.0415*c,f=.0557*a+ -0.204*b+1.057*c,d>.0031308?d=1.055*Math.pow(d,.4166666667)-.055:d=12.92*d,e>.0031308?e=1.055*Math.pow(e,.4166666667)-.055:e=12.92*e,f>.0031308?f=1.055*Math.pow(f,.4166666667)-.055:f=12.92*f;return{r:d*255,g:e*255,b:f*255}},xyz_to_lab:function(a,b,c){var d=95.047,e=100,f=108.883;a=a/d,b=b/e,c=c/f,a>.008856451679?a=Math.pow(a,.3333333333):a=7.787037037*a+.1379310345,b>.008856451679?b=Math.pow(b,.3333333333):b=7.787037037*b+.1379310345,c>.008856451679?c=Math.pow(c,.3333333333):c=7.787037037*c+.1379310345;var g=116*b-16,h=500*(a-b),i=200*(b-c);return{l:g,a:h,b:i}},lab_to_xyz:function(a,b,c){var d=(a+16)/116,e=d+b/500,f=d-c/200;e>.2068965517?e=e*e*e:e=.1284185493*(e-.1379310345),d>.2068965517?d=d*d*d:d=.1284185493*(d-.1379310345),f>.2068965517?f=f*f*f:f=.1284185493*(f-.1379310345);return{x:e*95.047,y:d*100,z:f*108.883}},hex_to_rgb:function(a){var b,c,d;a.charAt(0)==="#"&&(a=a.substr(1)),b=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),d=parseInt(a.substr(4,2),16);return{r:b,g:c,b:d}},bezier:function(a,b,c,d,e,f){var g,h,i,j,k,l,m=a[0],n=a[1],o=b[0],p=b[1],q=c[0],r=c[1],s=d[0],t=d[1],u,v,w,x={};i=3*(o-m),h=3*(q-o)-i,g=s-m-i-h,l=3*(p-n),k=3*(r-p)-l,j=t-n-l-k;for(var y=0;y<1e3;y++)u=y/1e3,v=Math.round(g*Math.pow(u,3)+h*Math.pow(u,2)+i*u+m),w=Math.round(j*Math.pow(u,3)+k*Math.pow(u,2)+l*u+n),e&&w<e?w=e:f&&w>f&&(w=f),x[v]=w;var z,A,B,C,D;if(x.length<d[0]+1)for(y=0;y<=d[0];y++)if(typeof x[y]=="undefined"){z=[y-1,x[y-1]];for(B=y;B<=d[0];B++)if(typeof x[B]!="undefined"){A=[B,x[B]];break}x[y]=z[1]+(A[1]-z[1])/(A[0]-z[0])*(y-z[0])}typeof x[d[0]]=="undefined"&&(x[d[0]]=x[254]);return x},distance:function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))}})}(Caman),function(a){a.remoteProxy="",a.extend(a.manip,{save:function(a){a&&(a=a.toLowerCase());if(!a||a!=="png"&&a!=="jpg")a="png";document.location.href=this.toBase64(a).replace("image/"+a,"image/octet-stream")},toImage:function(a){var b;b=document.createElement("img"),b.src=this.toBase64(a);return b},toBase64:function(a){a&&(a=a.toLowerCase());if(!a||a!=="png"&&a!=="jpg")a="png";return this.canvas.toDataURL("image/"+a)}})}(Caman),function(a){a.events={types:["processStart","processComplete","renderFinished"],fn:{trigger:function(b,c,d){var e=b,f=c,g=d;a.events.types.indexOf(b)!==-1&&(e=this,f=b,g=c),a.events.fn[f]&&a.sizeOf(a.events.fn[f])&&a.forEach(a.events.fn[f],function(a,b){a.call(e,g)})},listen:function(b,c,d){var e=b,f=c,g=d;a.events.types.indexOf(b)!==-1&&(e=this,f=b,g=c),a.events.fn[f]||(a.events.fn[f]=[]),a.events.fn[f].push(g);return!0}},cache:{}},a.forEach(["trigger","listen"],function(b){a[b]=a.events.fn[b]})}(Caman),function(a){a.manip.pixelInfo=function(a){this.loc=0,this.manip=a},a.manip.pixelInfo.prototype.locationXY=function(){var a,b;b=this.manip.dimensions.height-Math.floor(this.loc/(this.manip.dimensions.width*4)),a=this.loc%(this.manip.dimensions.width*4)/4;return{x:a,y:b}},a.manip.pixelInfo.prototype.getPixelRelative=function(a,b){var c=this.loc+this.manip.dimensions.width*4*b*-1+4*a;if(c>this.manip.pixel_data.length||c<0)return{r:0,g:0,b:0,a:0};return{r:this.manip.pixel_data[c],g:this.manip.pixel_data[c+1],b:this.manip.pixel_data[c+2],a:this.manip.pixel_data[c+3]}},a.manip.pixelInfo.prototype.putPixelRelative=function(a,b,c){var d=this.loc+this.manip.dimensions.width*4*b*-1+4*a;if(d>this.manip.pixel_data.length||d<0)return!1;this.manip.pixel_data[d]=c.r,this.manip.pixel_data[d+1]=c.g,this.manip.pixel_data[d+2]=c.b,this.manip.pixel_data[d+3]=c.a},a.manip.pixelInfo.prototype.getPixel=function(a,b){var c=(b*this.manip.dimensions.width+a)*4;return{r:this.manip.pixel_data[c],g:this.manip.pixel_data[c+1],b:this.manip.pixel_data[c+2],a:this.manip.pixel_data[c+3]}},a.manip.pixelInfo.prototype.putPixel=function(a,b,c){var d=(b*this.manip.dimensions.width+a)*4;this.manip.pixel_data[d]=c.r,this.manip.pixel_data[d+1]=c.g,this.manip.pixel_data[d+2]=c.b,this.manip.pixel_data[d+3]=c.a}}(Caman),function(a){a.renderBlocks=4,a.ProcessType={SINGLE:1,KERNEL:2,LAYER_DEQUEUE:3,LAYER_FINISHED:4,LOAD_OVERLAY:5,PLUGIN:6},a.manip.process=function(b,c){this.renderQueue.push({adjust:b,processFn:c,type:a.ProcessType.SINGLE});return this},a.manip.processKernel=function(b,c,d,e){if(!d){d=0;for(var f=0,g=c.length;f<g;f++)d+=c[f]}var h={name:b,adjust:c,divisor:d,bias:e||0};this.renderQueue.push({adjust:h,processFn:a.processKernel,type:a.ProcessType.KERNEL});return this},a.manip.processPlugin=function(b,c){this.renderQueue.push({type:a.ProcessType.PLUGIN,plugin:b,args:c});return this},a.manip.executePlugin=function(b,c){console.log("Executing plugin: "+b),a.plugin[b].apply(this,c),console.log("Plugin "+b+" finished!"),this.processNext()},a.manip.processNext=function(b){typeof b=="function"&&(this.finishedFn=b);if(this.renderQueue.length===0)a.trigger("renderFinished",{id:this.canvas_id}),typeof this.finishedFn=="function"&&this.finishedFn.call(this);else{var c=this.renderQueue.shift();if(c.type==a.ProcessType.LAYER_DEQUEUE){var d=this.canvasQueue.shift();this.executeLayer(d)}else c.type==a.ProcessType.LAYER_FINISHED?(this.applyCurrentLayer(),this.popContext(),this.processNext()):c.type==a.ProcessType.LOAD_OVERLAY?this.loadOverlay(c.layer,c.src):c.type==a.ProcessType.PLUGIN?this.executePlugin(c.plugin,c.args):this.executeFilter(c.adjust,c.processFn,c.type)}},a.extend(a,{processKernel:function(a,b,c,d){var e={r:0,g:0,b:0};for(var f=0,g=a.length;f<g;f++)e.r+=a[f]*b[f*3],e.g+=a[f]*b[f*3+1],e.b+=a[f]*b[f*3+2];e.r=e.r/c+d,e.g=e.g/c+d,e.b=e.b/c+d;return e}}),a.manip.executeFilter=function(b,c,d){var e=this.pixel_data.length,f=Math.floor(e/4/a.renderBlocks),g=f*4,h=g+e/4%a.renderBlocks*4,i=this,j=0,k=function(b){b>=0&&console.log("Block #"+b+" finished! Filter: "+c.name),j++;if(j==a.renderBlocks||b==-1)b>=0?console.log("Filter "+c.name+" finished!"):console.log("Kernel filter finished!"),a.trigger("processComplete",{id:i.canvas_id,completed:c.name}),i.processNext()},l=function(d,e,f){console.log("BLOCK #"+d+" - Filter: "+c.name+", Start: "+e+", End: "+f);var g=function(){var g={r:0,g:0,b:0,a:0},h=new this.pixelInfo(i),j;for(var l=e;l<f;l+=4)h.loc=l,g.r=this.pixel_data[l],g.g=this.pixel_data[l+1],g.b=this.pixel_data[l+2],j=c.call(h,b,g),this.pixel_data[l]=a.clampRGB(j.r),this.pixel_data[l+1]=a.clampRGB(j.g),this.pixel_data[l+2]=a.clampRGB(j.b);k(d)}.bind(this);setTimeout(g,0)},m=function(){var d=function(){var d=[],f,g,h,j,l,m=b.name,n=b.bias,o=b.divisor,p,q,r,s,t,u,v;b=b.adjust,p=Math.sqrt(b.length),l=[],console.log("Rendering kernel - Filter: "+m),h=i.dimensions.width*4*((p-1)/2),j=e-i.dimensions.width*4*((p-1)/2),q=(p-1)/2,f=new i.pixelInfo(i);for(s=h;s<j;s+=4){f.loc=s,r=0;for(t=-q;t<=q;t++)for(u=q;u>=-q;u--)g=f.getPixelRelative(t,u),d[r*3]=g.r,d[r*3+1]=g.g,d[r*3+2]=g.b,r++;v=c.call(f,b,d,o,n),l[s]=a.clampRGB(v.r),l[s+1]=a.clampRGB(v.g),l[s+2]=a.clampRGB(v.b),l[s+3]=255}for(s=h;s<j;s++)i.pixel_data[s]=l[s];k(-1)}.bind(this);setTimeout(d,0)};a.trigger("processStart",{id:this.canvas_id,start:c.name});if(d===a.ProcessType.SINGLE)for(var n=0;n<a.renderBlocks;n++){var o=n*g,p=o+(n==a.renderBlocks-1?h:g);l.call(this,n,o,p)}else m.call(this)},a.extend(a.manip,{revert:function(a){this.loadCanvas(this.options.image,this.options.canvas,a)},render:function(a){this.processNext(function(){this.context.putImageData(this.image_data,0,0),typeof a=="function"&&a.call(this)})}})}(Caman),function(a){a.manip.loadOverlay=function(b,c){var d=a.remoteCheck(c),e=this;d&&(c=d);var f=document.createElement("img");f.onload=function(){b.context.drawImage(f,0,0,e.dimensions.width,e.dimensions.height),b.image_data=b.context.getImageData(0,0,e.dimensions.width,e.dimensions.height),b.pixel_data=b.image_data.data,e.pixel_data=b.pixel_data,e.processNext()},f.src=c},a.manip.canvasLayer=function(b){this.options={blendingMode:"normal",opacity:1},this.layerID=a.uniqid.get(),this.canvas=document.createElement("canvas"),this.canvas.width=b.dimensions.width,this.canvas.height=b.dimensions.height,this.canvas.style.display="none",this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.image_data=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixel_data=this.image_data.data,this.__defineGetter__("filter",function(){return b});return this},a.manip.canvasLayer.prototype.newLayer=function(a){return this.filter.newLayer.call(this.filter,a)},a.manip.canvasLayer.prototype.setBlendingMode=function(a){this.options.blendingMode=a;return this},a.manip.canvasLayer.prototype.opacity=function(a){this.options.opacity=a/100;return this},a.manip.canvasLayer.prototype.copyParent=function(){var a=this.filter.pixel_data;for(var b=0;b<this.pixel_data.length;b+=4)this.pixel_data[b]=a[b],this.pixel_data[b+1]=a[b+1],this.pixel_data[b+2]=a[b+2],this.pixel_data[b+3]=a[b+3];return this},a.manip.canvasLayer.prototype.fillColor=function(){this.filter.fillColor.apply(this.filter,arguments);return this},a.manip.canvasLayer.prototype.overlayImage=function(b){b[0]=="#"?b=a.Caman.$(b).src:typeof b=="object"&&(b=b.src);if(!!b){this.filter.renderQueue.push({type:a.ProcessType.LOAD_OVERLAY,src:b,layer:this});return this}},a.manip.canvasLayer.prototype.render=function(){},a.manip.canvasLayer.prototype.applyToParent=function(){var b=this.filter.pixelStack[this.filter.pixelStack.length-1],c=this.filter.pixel_data,d={},e={},f={};for(var g=0;g<c.length;g+=4)d={r:b[g],g:b[g+1],b:b[g+2],a:b[g+3]},e={r:c[g],g:c[g+1],b:c[g+2],a:c[g+3]},f=this.blenders[this.options.blendingMode](e,d),f.r=a.clampRGB(f.r),f.g=a.clampRGB(f.g),f.b=a.clampRGB(f.b),b[g]=d.r-(d.r-f.r)*this.options.opacity*(f.a/255),b[g+1]=d.g-(d.g-f.g)*this.options.opacity*(f.a/255),b[g+2]=d.b-(d.b-f.b)*this.options.opacity*(f.a/255),b[g+3]=255},a.manip.canvasLayer.prototype.blenders={normal:function(a,b){return{r:a.r,g:a.g,b:a.b,a:255}},multiply:function(a,b){return{r:a.r*b.r/255,g:a.g*b.g/255,b:a.b*b.b/255,a:255}},screen:function(a,b){return{r:255-(255-a.r)*(255-b.r)/255,g:255-(255-a.g)*(255-b.g)/255,b:255-(255-a.b)*(255-b.b)/255,a:255}},overlay:function(a,b){var c={};c.r=b.r>128?255-2*(255-a.r)*(255-b.r)/255:b.r*a.r*2/255,c.g=b.g>128?255-2*(255-a.g)*(255-b.g)/255:b.g*a.g*2/255,c.b=b.b>128?255-2*(255-a.b)*(255-b.b)/255:b.b*a.b*2/255,c.a=255;return c},difference:function(a,b){return{r:a.r-b.r,g:a.g-b.g,b:a.b-b.b,a:255}},addition:function(a,b){return{r:b.r+a.r,g:b.g+a.g,b:b.b+a.b,a:255}},exclusion:function(a,b){return{r:128-2*(b.r-128)*(a.r-128)/255,g:128-2*(b.g-128)*(a.g-128)/255,b:128-2*(b.b-128)*(a.b-128)/255,a:255}},softLight:function(a,b){var c={};c.r=b.r>128?255-(255-b.r)*(255-(a.r-128))/255:b.r*(a.r+128)/255,c.g=b.g>128?255-(255-b.g)*(255-(a.g-128))/255:b.g*(a.g+128)/255,c.b=b.b>128?255-(255-b.b)*(255-(a.b-128))/255:b.b*(a.b+128)/255,c.a=255;return c}},a.manip.blenders=a.manip.canvasLayer.prototype.blenders,a.manip.canvasQueue=[],a.manip.newLayer=function(b){var c=new a.manip.canvasLayer(this);this.canvasQueue.push(c),this.renderQueue.push({type:a.ProcessType.LAYER_DEQUEUE}),b.call(c),this.renderQueue.push({type:a.ProcessType.LAYER_FINISHED});return this},a.manip.executeLayer=function(a){this.pushContext(a),this.processNext()},a.manip.pushContext=function(a){console.log("PUSH LAYER!"),this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixel_data),this.currentLayer=a,this.pixel_data=a.pixel_data},a.manip.popContext=function(){console.log("POP LAYER!"),this.pixel_data=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()},a.manip.applyCurrentLayer=function(){this.currentLayer.applyToParent()}}(Caman),function(a){a.manip.fillColor=function(){var b;arguments.length==1?b=a.hex_to_rgb(arguments[0]):b={r:arguments[0],g:arguments[1],b:arguments[2]};return this.process(b,function c(b,c){c.r=b.r,c.g=b.g,c.b=b.b;return c})},a.manip.brightness=function(a){a=Math.floor(255*(a/100));return this.process(a,function b(b,c){c.r+=b,c.g+=b,c.b+=b;return c})},a.manip.saturation=function(a){var b,c;a*=-0.01;return this.process(a,function d(d,e){var f;b=Math.max(e.r,e.g,e.b),e.r!==b&&(c=b-e.r,e.r+=c*d),e.g!==b&&(c=b-e.g,e.g+=c*d),e.b!==b&&(c=b-e.b,e.b+=c*d);return e})},a.manip.vibrance=function(a){var b,c,d,e;a*=-1;return this.process(a,function f(f,g){var h;b=Math.max(g.r,g.g,g.b),c=(g.r+g.g+g.b)/3,d=Math.abs(b-c)*2/255*f/100,g.r!==b&&(e=b-g.r,g.r+=e*d),g.g!==b&&(e=b-g.g,g.g+=e*d),g.b!==b&&(e=b-g.b,g.b+=e*d);return g})},a.manip.greyscale=function(){return this.process({},function(b,c){var d=.3*c.r+.59*c.g+.11*c.b;c.r=d,c.g=d,c.b=d;return c})},a.manip.contrast=function(a){a=(a+100)/100,a=Math.pow(a,2);return this.process(a,function b(b,c){c.r/=255,c.r-=.5,c.r*=b,c.r+=.5,c.r*=255,c.g/=255,c.g-=.5,c.g*=b,c.g+=.5,c.g*=255,c.b/=255,c.b-=.5,c.b*=b,c.b+=.5,c.b*=255,c.r>255?c.r=255:c.r<0&&(c.r=0),c.g>255?c.g=255:c.g<0&&(c.g=0),c.b>255?c.b=255:c.b<0&&(c.b=0);return c})},a.manip.hue=function(b){var c,d;return this.process(b,function e(e,f){var g;c=a.rgb_to_hsv(f.r,f.g,f.b),d=c.h*100,d+=Math.abs(e),d=d%100,d/=100,c.h=d,g=a.hsv_to_rgb(c.h,c.s,c.v);return{r:g.r,g:g.g,b:g.b}})},a.manip.colorize=function(){var b,c,d;arguments.length===2?(c=a.hex_to_rgb(arguments[0]),d=arguments[1]):arguments.length===4&&(c={r:arguments[0],g:arguments[1],b:arguments[2]},d=arguments[3]);return this.process([d,c],function(b,c){c.r-=(c.r-b[1].r)*(b[0]/100),c.g-=(c.g-b[1].g)*(b[0]/100),c.b-=(c.b-b[1].b)*(b[0]/100);return c})},a.manip.invert=function(){return this.process({},function(b,c){c.r=255-c.r,c.g=255-c.g,c.b=255-c.b;return c})},a.manip.sepia=function(a){a===undefined&&(a=100),a=a/100;return this.process(a,function b(b,c){c.r=Math.min(255,c.r*(1-.607*b)+c.g*.769*b+c.b*.189*b),c.g=Math.min(255,c.r*.349*b+c.g*(1-.314*b)+c.b*.168*b),c.b=Math.min(255,c.r*.272*b+c.g*.534*b+c.b*(1-.869*b));return c})},a.manip.gamma=function(a){return this.process(a,function b(b,c){c.r=Math.pow(c.r/255,b)*255,c.g=Math.pow(c.g/255,b)*255,c.b=Math.pow(c.b/255,b)*255;return c})},a.manip.noise=function(b){b=Math.abs(b)*2.55;return this.process(b,function c(c,d){var e=a.randomRange(c*-1,c);d.r+=e,d.g+=e,d.b+=e;return d})},a.manip.clip=function(a){a=Math.abs(a)*2.55;return this.process(a,function b(b,c){c.r>255-b?c.r=255:c.r<b&&(c.r=0),c.g>255-b?c.g=255:c.g<b&&(c.g=0),c.b>255-b?c.b=255:c.b<b&&(c.b=0);return c})},a.manip.channels=function(a){if(typeof a=="object"){for(var b in a)if(a.hasOwnProperty(b)){if(a[b]===0){delete a[b];continue}a[b]=a[b]/100}if(a.length===0)return;return this.process(a,function c(b,c){b.red&&(b.red>0?c.r=c.r+(255-c.r)*b.red:c.r=c.r-c.r*Math.abs(b.red)),b.green&&(b.green>0?c.g=c.g+(255-c.g)*b.green:c.g=c.g-c.g*Math.abs(b.green)),b.blue&&(b.blue>0?c.b=c.b+(255-c.b)*b.blue:c.b=c.b-c.b*Math.abs(b.blue));return c})}},a.manip.curves=function(b,c,d,e,f){var g,h;typeof b=="string"&&(b=="rgb"?b=["r","g","b"]:b=[b]),g=a.bezier(c,d,e,f,0,255);if(c[0]>0)for(h=0;h<c[0];h++)g[h]=c[1];if(f[0]<255)for(h=f[0];h<=255;h++)g[h]=f[1];return this.process({bezier:g,chans:b},function(b,c){for(var d=0;d<b.chans.length;d++)c[b.chans[d]]=b.bezier[c[b.chans[d]]];return c})},a.manip.exposure=function(a){var b,c,d;b=Math.abs(a)/100,c=[0,255*b],d=[255-255*b,255],a<0&&(c=c.reverse(),d=d.reverse());return this.curves("rgb",[0,0],c,d,[255,255])}}(Caman)