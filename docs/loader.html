<!DOCTYPE html>  <html> <head>   <title>loader.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="events.html">                 events.js               </a>                                           <a class="source" href="filters.html">                 filters.js               </a>                                           <a class="source" href="header.html">                 header.js               </a>                                           <a class="source" href="io.html">                 io.js               </a>                                           <a class="source" href="layers.html">                 layers.js               </a>                                           <a class="source" href="loader.html">                 loader.js               </a>                                           <a class="source" href="pixelInfo.html">                 pixelInfo.js               </a>                                           <a class="source" href="render.html">                 render.js               </a>                                           <a class="source" href="util.html">                 util.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               loader.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This is actually where the Caman object is defined, and is where the Caman initialization code resides. 
There are many different initialization for Caman, which are described on the 
<a href="http://camanjs.com/docs">Basic Usage</a> page.</p>

<p>Initialization is tricky because we need to make sure everything we need is actually fully loaded in the 
DOM before proceeding. When initialized on an image, we need to make sure that the image is done loading 
before converting it to a canvas element and writing the pixel data. If we do this prematurely, the browser
will throw a DOM Error, and chaos will ensue. In the event that we initialize Caman on a canvas element 
while specifying an image URL, we need to create a new image element, load the image, then continue with 
initialization.</p>

<p>The main goal for Caman was simplicity, so all of this is handled transparently to the end-user. This is also
why this piece of code is a bit lengthy. Once everything is loaded, and Caman is initialized, the callback 
function is fired.</p>

<p>ï¿½There are also a few utility functions in this file that are used throughout the Caman source. Caman.$ is a 
simple helper for retrieving DOM nodes by ID. There are also a few functions for handling and detecting remote images.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global Caman: true */</span> 
<span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Ensure compatibility for browsers without JS debugging consoles</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;console&#39;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">console</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">log</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">info</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Here it begins. Caman is defined.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Caman</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>1 argument = init image or retrieve manip object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="p">{</span>      
      
      <span class="k">return</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
      
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Not initialized; load Caman</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">new</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadImage</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>2 arguments - init image and/or invoke callback</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="k">if</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Already initialized, invoke callback with manip set to 'this'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Not initialized; load Caman into image then invoke callback and return manip</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">==</span> <span class="s2">&quot;img&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadImage</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">==</span> <span class="s2">&quot;canvas&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Initialize on a canvas without an image</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">return</span> <span class="k">new</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadCanvas</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
        
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Not initialized; load image URL into canvas and return manip</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="k">new</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadCanvas</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>3 arguments - init image URL into canvas and invoke callback</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="p">{</span>
    </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Already initialized; invoke callback and return manip</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
      
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Not initialized; load image into canvas, invoke callback, and return manip</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">new</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadCanvas</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Simple version information</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">release</span><span class="o">:</span> <span class="s2">&quot;2.3&quot;</span><span class="p">,</span>
  <span class="nx">date</span><span class="o">:</span> <span class="s2">&quot;7-5-2011&quot;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Private function for finishing Caman initialization</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">finishInit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Used for saving pixel layers</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">pixelStack</span> <span class="o">=</span> <span class="p">[];</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Stores all of the layers waiting to be rendered</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">layerStack</span> <span class="o">=</span> <span class="p">[];</span>
  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Stores all of the render operatives for the renderer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">renderQueue</span> <span class="o">=</span> <span class="p">[];</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Store a reference to the canvas element</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">;</span>  
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">image</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If we are initializing with an image, we inspect the HTML5 data elements camanwidth and camanheight
to see if we need to scale the canvas at all.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">old_height</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">old_width</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">new_width</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanwidth&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanwidth&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">new_height</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanheight&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanheight&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">new_width</span> <span class="o">||</span> <span class="nx">new_height</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">new_width</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">new_width</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">new_height</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">new_height</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">old_height</span> <span class="o">/</span> <span class="nx">old_width</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">new_height</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">new_height</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">old_width</span> <span class="o">/</span> <span class="nx">old_height</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Update the canvas sizes to match the image sizes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Draw the image onto the canvas</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span> 
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Get and store references to the image data and pixel array</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">image_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">image_data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Store a simple reference to the canvas dimensions, which really comes in handy with some filters</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">width</span><span class="o">:</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
    <span class="nx">height</span><span class="o">:</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Store a long-living reference to the Caman object that can be found in a global scope.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Execute the user's callback function to begin defining transformations</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Used for loading Caman onto an image element</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">loadImage</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">image_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">domLoaded</span><span class="p">,</span>
    <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
    <span class="nx">image</span><span class="p">,</span> <span class="nx">proxyURL</span><span class="p">,</span>
    <span class="nx">startFn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
      
      <span class="k">if</span><span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">image_id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">image_id</span><span class="p">).</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;img&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>element doesn't exist or isn't an image</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">throw</span> <span class="s2">&quot;Given element ID isn&#39;t an image: &quot;</span> <span class="o">+</span> <span class="nx">image_id</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">canvas</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanwidth&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanwidth&#39;</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanwidth&#39;</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanheight&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanheight&#39;</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-camanheight&#39;</span><span class="p">));</span>
      <span class="p">}</span>
      
      <span class="nx">image</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">image</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Store the canvas ID</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">canvas_id</span> <span class="o">=</span> <span class="nx">image_id</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">canvas</span><span class="o">:</span> <span class="nx">image_id</span><span class="p">,</span>
        <span class="nx">image</span><span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">src</span>
      <span class="p">};</span>
      
      <span class="nx">finishInit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Default callback</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
    </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Check to see if we've been passed a DOM node or a string representing
the node's ID</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">image_id</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">image_id</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;img&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>DOM node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">image_id</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>If the image has an ID, use it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">image_id</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">image_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Otherwise, generate a unique ID for the image</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">image_id</span> <span class="o">=</span> <span class="s2">&quot;caman-&quot;</span> <span class="o">+</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">uniqid</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">image_id</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Need to see if DOM is loaded already</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">domLoaded</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">image_id</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">domLoaded</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>DOM loaded, proceed immediately</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">image</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">image_id</span><span class="p">);</span>
      <span class="nx">proxyURL</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteCheck</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">src</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">proxyURL</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Image is remote. Reload image via proxy</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">proxyURL</span><span class="p">;</span>
        
        <span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">startFn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">complete</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">startFn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">startFn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
          <span class="p">};</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>If it's not, wait for the DOM to load before continuing to prevent errors</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">image</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">image_id</span><span class="p">);</span>
        <span class="nx">proxyURL</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteCheck</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">src</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">proxyURL</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Image is remote. Reload image via proxy</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">proxyURL</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">startFn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Used for initializing Caman onto a canvas element already in the DOM</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">loadCanvas</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">canvas_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">domLoaded</span><span class="p">,</span>
    <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
    <span class="nx">startFn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">canvas_id</span><span class="p">),</span>
      <span class="nx">image</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">),</span>
      <span class="nx">proxyURL</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteCheck</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">canvas_id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">canvas_id</span><span class="p">).</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;canvas&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>element doesn't exist or isn't a canvas</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">throw</span> <span class="s2">&quot;Given element ID isn&#39;t a canvas: &quot;</span> <span class="o">+</span> <span class="nx">canvas_id</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">url</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>No image to load into the canvas, so we simply continue</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">finishInit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Load the image, and complete initialization when it loads</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">finishInit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="p">};</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">proxyURL</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">proxyURL</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">canvas_id</span> <span class="o">=</span> <span class="nx">canvas_id</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">canvas</span><span class="o">:</span> <span class="nx">canvas_id</span><span class="p">,</span>
        <span class="nx">image</span><span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">src</span>
      <span class="p">};</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Default callback</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
    </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Check to see if we've been passed a DOM node or a string representing
the node's ID</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">canvas_id</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">canvas_id</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;canvas&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>DOM node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">canvas_id</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">canvas_id</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">canvas_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">canvas_id</span> <span class="o">=</span> <span class="s2">&quot;caman-&quot;</span> <span class="o">+</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">uniqid</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">canvas_id</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Need to see if DOM is loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">domLoaded</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">canvas_id</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">domLoaded</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">startFn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">startFn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
      <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>In order to avoid having 3 different types of object contexts here, we simply set the prototypes
of loadImage and loadCanvas to Caman.manip.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadImage</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">;</span>
<span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadCanvas</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Helper function since document.getElementById()
is a mouthful. Note that this will not conflict
with jQuery since this Caman.$ variable does not exist
in the global window scope.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Caman</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Checks a URL to determine if it is remote or not.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">isRemote</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Regex for extracting the domain of an image</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">domain_regex</span> <span class="o">=</span> <span class="sr">/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/</span><span class="p">,</span>
  <span class="nx">test_domain</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">url</span> <span class="o">||</span> <span class="o">!</span><span class="nx">url</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">domain_regex</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">test_domain</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  
    <span class="k">return</span> <span class="nx">test_domain</span> <span class="o">!=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Checks to see if an image is remote. If it is, and a proxy is defined, it returns the proxy URL.
If it's remote and no proxy URL is defined, it will log an error and attempt to continue.
Anything else and it returns null.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteCheck</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Check to see if image is remote or not</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">isRemote</span><span class="p">(</span><span class="nx">src</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteProxy</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;Attempting to load remote image without a configured proxy, URL: &quot;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">isRemote</span><span class="p">(</span><span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteProxy</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;Cannot use a remote proxy for loading remote images due to same-origin policy&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>We have a remote proxy setup properly, so lets alter the image src</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteProxy</span> <span class="o">+</span> <span class="s2">&quot;?url=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">Caman</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">;</span>

<span class="p">}());</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 