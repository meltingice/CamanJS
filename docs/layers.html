<!DOCTYPE html>  <html> <head>   <title>layers.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="events.html">                 events.js               </a>                                           <a class="source" href="filters.html">                 filters.js               </a>                                           <a class="source" href="header.html">                 header.js               </a>                                           <a class="source" href="io.html">                 io.js               </a>                                           <a class="source" href="layers.html">                 layers.js               </a>                                           <a class="source" href="loader.html">                 loader.js               </a>                                           <a class="source" href="pixelInfo.html">                 pixelInfo.js               </a>                                           <a class="source" href="render.html">                 render.js               </a>                                           <a class="source" href="util.html">                 util.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               layers.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The entire layering system for Caman resides in this file. Layers get their own canvasLayer object 
which is created when newLayer() is called. For extensive information regarding the specifics of how 
the layering system works, there is an in-depth blog post on this very topic. Instead of copying the 
entirety of that post, I'll simply point you towards the blog link.</p>

<p>However, the gist of the layering system is that, for each layer, it creates a new canvas element and 
then either copies the parent layer's data or applies a solid color to the new layer. After some (optional) 
effects are applied, the layer is blended back into the parent canvas layer using one of many different 
blending algorithms.</p>

<p>You can also load an image (local or remote, with a proxy) into a canvas layer, which is useful if you want 
to add textures to an image.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global Caman: true */</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Caman</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Loads another image into a canvas layer that can be either local or remote (with a proxy). This function is
executed at render time so that the end-user doesn't have to worry about the image loading asynchronously.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">loadOverlay</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">layer</span><span class="p">,</span> <span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">proxyUrl</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">remoteCheck</span><span class="p">(</span><span class="nx">src</span><span class="p">),</span>
  <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Apply the proxy if the image is remote and a proxy exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">proxyUrl</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">src</span> <span class="o">=</span> <span class="nx">proxyUrl</span><span class="p">;</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Create an image element, apply the URL, and wait for load</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">);</span>
  <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Once the image loads, draw it on to the layer's canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">layer</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="nx">layer</span><span class="p">.</span><span class="nx">image_data</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="nx">layer</span><span class="p">.</span><span class="nx">pixel_data</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">image_data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    
    <span class="nx">self</span><span class="p">.</span><span class="nx">pixel_data</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Done! Move to the next render operative</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">processNext</span><span class="p">();</span>
  <span class="p">};</span>
  
  <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Object that represents a canvas layer</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">manip</span><span class="p">)</span> <span class="p">{</span>  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Default options</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">blendingMode</span><span class="o">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
    <span class="nx">opacity</span><span class="o">:</span> <span class="mf">1.0</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Create a blank and invisible canvas. We store the reference to the canvas as a part of the canvasLayer
object instead of appending it to the DOM.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">layerID</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">uniqid</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Give the canvas the same dimensions as the parent canvas</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">manip</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">manip</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">createImageData</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">image_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">image_data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Define a getter for filter that returns the manip object so that we can use all of the normal
filters on this layer.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">__defineGetter__</span><span class="p">(</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">manip</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Enables nesting of layers since this calls the newLayer function from the manip object, but
changes the context of <code>this</code> to this layer instead of the original parent canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">newLayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">newLayer</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Sets the blending mode to one of the defined blenders</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setBlendingMode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">blendingMode</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Sets the opacity of the layer, which dictates how much of the layer is applied during blending.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opacity</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opacity</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Copies the contents of the parent layer to this layer.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyParent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Grab the pixel data from the parent layer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">parentData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Unfortunately we can't set this all at once since (I believe) that would create a reference
to the parent pixel array instead of copying the data. By directly setting the individual
primitive values, they become copied.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>    <span class="o">=</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Shortcut for flooding this layer with a solid color</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fillColor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">fillColor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Load a remote image and overlay it on this layer. The image will be downloaded and applied at render-time,
so this function is not asynchronous.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">overlayImage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">image</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If the given image is a DOM ID instead of a URL</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">image</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">image</span><span class="p">).</span><span class="nx">src</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">image</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If the given image is a DOM image object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">image</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">src</span><span class="p">;</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Some problem, skip to prevent errors</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">image</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">renderQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">ProcessType</span><span class="p">.</span><span class="nx">LOAD_OVERLAY</span><span class="p">,</span> <span class="nx">src</span><span class="o">:</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">layer</span><span class="o">:</span> <span class="k">this</span><span class="p">});</span>
  
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Leaving this here for compatibility reasons. It is NO
LONGER REQUIRED at the end of the layer.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Apply the content of this layer to the parent layer. This occurs at render time and should never be directly
called by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">applyToParent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Grab the parent's pixel data off of the pixel stack</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">parentData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">pixelStack</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">pixelStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
  <span class="nx">layerData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">,</span>
  <span class="nx">rgbaParent</span> <span class="o">=</span> <span class="p">{},</span>
  <span class="nx">rgbaLayer</span> <span class="o">=</span> <span class="p">{},</span>
  <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">layerData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Create an RGBA object for the parent layer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">rgbaParent</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
      <span class="nx">g</span><span class="o">:</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">b</span><span class="o">:</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
      <span class="nx">a</span><span class="o">:</span> <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
    <span class="p">};</span>
    </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Create an RGBA object for this layer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">rgbaLayer</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="nx">layerData</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
      <span class="nx">g</span><span class="o">:</span> <span class="nx">layerData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">b</span><span class="o">:</span> <span class="nx">layerData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
      <span class="nx">a</span><span class="o">:</span> <span class="nx">layerData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
    <span class="p">};</span>
    </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Send the parent and layer RGBA data for this pixel to the specified blender</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">blenders</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">blendingMode</span><span class="p">](</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">);</span>
    </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Clamp the RGB values to follow the latest canvas spec.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">result</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">clampRGB</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">clampRGB</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">g</span><span class="p">);</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">clampRGB</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>
    
    <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>   <span class="o">=</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">-</span> <span class="p">((</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">-</span> <span class="nx">result</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">*</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">a</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)));</span>
    <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">-</span> <span class="p">((</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">-</span> <span class="nx">result</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">*</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">a</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)));</span>
    <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="p">((</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">result</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">*</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">a</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)));</span>
    <span class="nx">parentData</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Built-in layer blenders. Many of these mimic Photoshop blend modes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">blenders</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Directly apply the child layer's pixels to the parent layer with no special changes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">normal</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
      <span class="nx">g</span><span class="o">:</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span>
      <span class="nx">b</span><span class="o">:</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span>
      <span class="nx">a</span><span class="o">:</span> <span class="mi">255</span>
    <span class="p">};</span>
  <span class="p">},</span>
  </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Apply the child to the parent by multiplying the color values. This generally creates contrast.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">multiply</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>
      <span class="nx">g</span><span class="o">:</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>
      <span class="nx">b</span><span class="o">:</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>
      <span class="nx">a</span><span class="o">:</span> <span class="mi">255</span>
    <span class="p">};</span>
  <span class="p">},</span>
  
  <span class="nx">screen</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="mi">255</span> <span class="o">-</span> <span class="p">(((</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span><span class="p">))</span> <span class="o">/</span> <span class="mi">255</span><span class="p">),</span>
      <span class="nx">g</span><span class="o">:</span> <span class="mi">255</span> <span class="o">-</span> <span class="p">(((</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span><span class="p">))</span> <span class="o">/</span> <span class="mi">255</span><span class="p">),</span>
      <span class="nx">b</span><span class="o">:</span> <span class="mi">255</span> <span class="o">-</span> <span class="p">(((</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span><span class="p">))</span> <span class="o">/</span> <span class="mi">255</span><span class="p">),</span>
      <span class="nx">a</span><span class="o">:</span> <span class="mi">255</span>
    <span class="p">};</span>
  <span class="p">},</span>
  
  <span class="nx">overlay</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> 
      <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">?</span> 
        <span class="mi">255</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="o">:</span> 
        <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">;</span>
        
    <span class="nx">result</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> 
      <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">?</span> 
        <span class="mi">255</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="o">:</span> 
        <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">;</span>
        
    <span class="nx">result</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> 
      <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">?</span> 
        <span class="mi">255</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="o">:</span> 
        <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">;</span>
    
    <span class="nx">result</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">},</span>
  
  <span class="nx">difference</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
      <span class="nx">g</span><span class="o">:</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span>
      <span class="nx">b</span><span class="o">:</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span>
      <span class="nx">a</span><span class="o">:</span> <span class="mi">255</span>
    <span class="p">};</span>
  <span class="p">},</span>
  
  <span class="nx">addition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">+</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
      <span class="nx">g</span><span class="o">:</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">+</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span>
      <span class="nx">b</span><span class="o">:</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">+</span> <span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span>
      <span class="nx">a</span><span class="o">:</span> <span class="mi">255</span>
    <span class="p">};</span>
  <span class="p">},</span>
  
  <span class="nx">exclusion</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="mi">128</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>
      <span class="nx">g</span><span class="o">:</span> <span class="mi">128</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>
      <span class="nx">b</span><span class="o">:</span> <span class="mi">128</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>
      <span class="nx">a</span><span class="o">:</span> <span class="mi">255</span>
    <span class="p">};</span>
  <span class="p">},</span>
  
  <span class="nx">softLight</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">,</span> <span class="nx">rgbaParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="nx">result</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> 
      <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">?</span> 
        <span class="mi">255</span> <span class="o">-</span> <span class="p">((</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">255</span> <span class="o">:</span> 
        <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">r</span> <span class="o">+</span> <span class="mi">128</span><span class="p">))</span> <span class="o">/</span> <span class="mi">255</span><span class="p">;</span>
      
    <span class="nx">result</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> 
      <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">?</span> 
        <span class="mi">255</span> <span class="o">-</span> <span class="p">((</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">255</span> <span class="o">:</span> 
        <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">g</span> <span class="o">+</span> <span class="mi">128</span><span class="p">))</span> <span class="o">/</span> <span class="mi">255</span><span class="p">;</span>
    
    <span class="nx">result</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">?</span> 
      <span class="mi">255</span> <span class="o">-</span> <span class="p">((</span><span class="mi">255</span> <span class="o">-</span> <span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">255</span> <span class="o">:</span> 
      <span class="p">(</span><span class="nx">rgbaParent</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rgbaLayer</span><span class="p">.</span><span class="nx">b</span> <span class="o">+</span> <span class="mi">128</span><span class="p">))</span> <span class="o">/</span> <span class="mi">255</span><span class="p">;</span>
      
    <span class="nx">result</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Add the blenders object to the Caman.manip namespace to make it easier to extend.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">blenders</span> <span class="o">=</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">blenders</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Queue that holds all of the layers that are waiting to be rendered</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasQueue</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Factory method that creates a new layer and adds the layer to the render queue once
all of the modifications are defined via the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">newLayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">layer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">canvasLayer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Store the new layer in the canvas queue for rendering later</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">canvasQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Inform the renderer that we have a new layer coming up</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">renderQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">ProcessType</span><span class="p">.</span><span class="nx">LAYER_DEQUEUE</span><span class="p">});</span>  
  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Define the layer transformations</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Let the renderer know the layer is finished</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">renderQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="nx">Caman</span><span class="p">.</span><span class="nx">ProcessType</span><span class="p">.</span><span class="nx">LAYER_FINISHED</span><span class="p">});</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Used during the rendering process. Directly correlates to the LAYER_DEQUEUE render event.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">executeLayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">layer</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pushContext</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">processNext</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Changes the rendering context to the upcoming layer for rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">pushContext</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">layer</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;PUSH LAYER!&quot;</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Push the layer onto the layer stack for processing</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">layerStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentLayer</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Also push the pixel array into its own stack</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">pixelStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Set the reference to the current layer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">currentLayer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Set the current pixel data array to the layer's pixel data</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">pixel_data</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Once we are done rendering a layer, we can move back to the parent layer's context. This directly
correlates to the LAYER_FINISHED render event.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">popContext</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;POP LAYER!&quot;</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Restore the parent's pixel data (which has been modified by a blending function)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">pixel_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pixelStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  </pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Restore the reference to the current layer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">currentLayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">layerStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Shortcut for applying the current layer to the parent layer</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Caman</span><span class="p">.</span><span class="nx">manip</span><span class="p">.</span><span class="nx">applyCurrentLayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">currentLayer</span><span class="p">.</span><span class="nx">applyToParent</span><span class="p">();</span>
<span class="p">};</span>

<span class="p">}(</span><span class="nx">Caman</span><span class="p">));</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 