
(function(){var forEach=Array.prototype.forEach,hasOwn=Object.prototype.hasOwnProperty,slice=Array.prototype.slice,Caman=function(options){if(typeof options==="string"){var temp=options;if(arguments.length===1){options=temp;}else{options={src:temp,canvas:arguments[1]||"",ready:arguments[2]||false};}}
if(options.context&&options.canvas_id){options=options.canvas_id;}
return new Caman.manip.load(options);};if(!('console'in window)){window.console={log:function(){},info:function(){},error:function(){}};}
Caman.ready=false;Caman.store={};Caman.renderBlocks=4;Caman.manip=Caman.prototype={load:function(options){var
img=document.createElement("img"),imageReady=function(){var args=arguments.length,canvas_id=!args?options.canvas:arguments[0],canvas;if(!args&&canvas_id.substr(0,1)==="#"){canvas=document.getElementById(canvas_id.substr(1));if(!canvas){return;}}else{return Caman.store[canvas_id];}
canvas.width=img.width;canvas.height=img.height;this.canvas=canvas;this.canvas_id=canvas_id;this.context=canvas.getContext("2d");this.context.drawImage(img,0,0);this.image_data=this.context.getImageData(0,0,img.width,img.height);this.pixel_data=this.image_data.data;this.dimensions={width:img.width,height:img.height};this.renderQueue=[];options.ready&&options.ready.call(this,this);Caman.store[canvas_id]=this;return this;},that=this;this.options=options;if(typeof options!=="string"){img.src=options.src;img.onload=function(){imageReady.call(that);};if(!Caman.ready){document.addEventListener("DOMContentLoaded",function(){Caman.ready=true;},false);}}else{return Caman.store[options];}
return this;},save:function(type){if(type){type=type.toLowerCase();}
if(!type||(type!=='png'&&type!=='jpg')){type='png';}
var data=this.toBase64(type).replace("image/"+type,"image/octet-stream");document.location.href=data;},toImage:function(type){var img,data;data=this.toBase64(type);img=document.createElement('img');img.src=data;return img;},toBase64:function(type){if(type){type=type.toLowerCase();}
if(!type||(type!=='png'&&type!=='jpg')){type='png';}
return this.canvas.toDataURL("image/"+type);},revert:function(){this.options.ready=function(){};this.load(this.options);},render:function(callback){this.processNext(function(){this.context.putImageData(this.image_data,0,0);if(typeof callback==='function'){callback.call(this);}});}};Caman.manip.load.prototype=Caman.manip;Caman.forEach=function(obj,fn,context){if(!obj||!fn){return{};}
context=context||this;if(forEach&&obj.forEach===forEach){return obj.forEach(fn,context);}
for(var key in obj){if(hasOwn.call(obj,key)){fn.call(context,obj[key],key,obj);}}
return obj;};Caman.extend=function(obj){var dest=obj,src=slice.call(arguments,1);Caman.forEach(src,function(copy){for(var prop in copy){dest[prop]=copy[prop];}});return dest;};Caman.extend(Caman,{sizeOf:function(obj){var size=0,prop;for(prop in obj){size++;}
return size;},sameAs:function(base,test){if(base.length!==test.length){return false;}
for(var i=base.length;i>=0;i--){if(base[i]!==test[i]){return false;}}
return true;},remove:function(arr,item){var ret=[];for(var i=0,len=arr.length;i<len;i++){if(arr[i]!==item){ret.push(arr[i]);}}
arr=ret;return ret;},randomRange:function(min,max,float){var rand=min+(Math.random()*(max-min));return typeof float=='undefined'?Math.round(rand):rand.toFixed(float);},rgb_to_hsl:function(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b),h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return{h:h,s:s,l:l};},hsl_to_rgb:function(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return{r:r*255,g:g*255,b:b*255};},rgb_to_hsv:function(r,g,b){r=r/255,g=g/255,b=b/255;var max=Math.max(r,g,b),min=Math.min(r,g,b),h,s,v=max,d=max-min;s=max==0?0:d/max;if(max==min){h=0;}else{switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return{h:h,s:s,v:v};},hsv_to_rgb:function(h,s,v){var r,g,b,i=Math.floor(h*6),f=h*6-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s);switch(i%6){case 0:r=v,g=t,b=p;break;case 1:r=q,g=v,b=p;break;case 2:r=p,g=v,b=t;break;case 3:r=p,g=q,b=v;break;case 4:r=t,g=p,b=v;break;case 5:r=v,g=p,b=q;break;}
return{r:r*255,g:g*255,b:b*255};},rgb_to_xyz:function(r,g,b){r=r/255;g=g/255;b=b/255;if(r>0.04045){r=Math.pow((r+0.055)/1.055,2.4);}else{r=r/12.92;}
if(g>0.04045){g=Math.pow((g+0.055)/1.055,2.4);}else{g=g/12.92;}
if(b>0.04045){b=Math.pow((b+0.055)/1.055,2.4);}else{b=b/12.92;}
var x=r*0.4124+g*0.3576+b*0.1805;var y=r*0.2126+g*0.7152+b*0.0722;var z=r*0.0193+g*0.1192+b*0.9505;return{x:x*100,y:y*100,z:z*100};},xyz_to_rgb:function(x,y,z){x=x/100;y=y/100;z=z/100;var r,g,b;r=(3.2406*x)+(-1.5372*y)+(-0.4986*z);g=(-0.9689*x)+(1.8758*y)+(0.0415*z);b=(0.0557*x)+(-0.2040*y)+(1.0570*z);if(r>0.0031308){r=(1.055*Math.pow(r,0.4166666667))-0.055;}else{r=12.92*r;}
if(g>0.0031308){g=(1.055*Math.pow(g,0.4166666667))-0.055;}else{g=12.92*g;}
if(b>0.0031308){b=(1.055*Math.pow(b,0.4166666667))-0.055;}else{b=12.92*b;}
return{r:r*255,g:g*255,b:b*255};},xyz_to_lab:function(x,y,z){var whiteX=95.047,whiteY=100.0,whiteZ=108.883
x=x/whiteX;y=y/whiteY;z=z/whiteZ;if(x>0.008856451679){x=Math.pow(x,0.3333333333);}else{x=(7.787037037*x)+0.1379310345;}
if(y>0.008856451679){y=Math.pow(y,0.3333333333);}else{y=(7.787037037*y)+0.1379310345;}
if(z>0.008856451679){z=Math.pow(z,0.3333333333);}else{z=(7.787037037*z)+0.1379310345;}
var l=116*y-16;var a=500*(x-y);var b=200*(y-z);return{l:l,a:a,b:b};},lab_to_xyz:function(l,a,b){var y=(l+16)/116;var x=y+(a/500);var z=y-(b/200);if(x>0.2068965517){x=x*x*x;}else{x=0.1284185493*(x-0.1379310345);}
if(y>0.2068965517){y=y*y*y;}else{y=0.1284185493*(y-0.1379310345);}
if(z>0.2068965517){z=z*z*z;}else{z=0.1284185493*(z-0.1379310345);}
return{x:x*95.047,y:y*100.0,z:z*108.883};},hex_to_rgb:function(hex){var r,g,b;if(hex.charAt(0)==="#"){hex=hex.substr(1);}
r=parseInt(hex.substr(0,2),16);g=parseInt(hex.substr(2,2),16);b=parseInt(hex.substr(4,2),16);return{r:r,g:g,b:b};}});Caman.events={types:["processStart","processComplete","renderFinished"],fn:{trigger:function(target,type,data){var _target=target,_type=type,_data=data;if(Caman.events.types.indexOf(target)!==-1){_target=this;_type=target;_data=type;}
if(Caman.events.fn[_type]&&Caman.sizeOf(Caman.events.fn[_type])){Caman.forEach(Caman.events.fn[_type],function(obj,key){obj.call(_target,_data);});}},listen:function(target,type,fn){var _target=target,_type=type,_fn=fn;if(Caman.events.types.indexOf(target)!==-1){_target=this;_type=target;_fn=type;}
if(!Caman.events.fn[_type]){Caman.events.fn[_type]=[];}
Caman.events.fn[_type].push(_fn);return true;}},cache:{}};(function(Caman){Caman.forEach(["trigger","listen"],function(key){Caman[key]=Caman.events.fn[key];});})(Caman);Caman.manip.pixelInfo=function(loc){var self=this;return{loc:loc,getPixel:function(horiz_offset,vert_offset){var newLoc=this.loc+(self.dimensions.width*(vert_offset*-1))+(4*horiz_offset);if(newLoc>self.pixel_data.length||newLoc<0){return false;}
return{r:self.pixel_data[newLoc],g:self.pixel_data[newLoc+1],b:self.pixel_data[newLoc+2],a:self.pixel_data[newLoc+3]};}};};Caman.manip.executeFilter=function(adjust,processFn){var n=this.pixel_data.length,res=null,blockPixelLength=Math.floor((n/4)/Caman.renderBlocks),blockN=blockPixelLength*4,lastBlockN=blockN+((n/4)%Caman.renderBlocks)*4,self=this,render_block=function(bnum,start,end){console.log("BLOCK #"+bnum+" - Filter: "+processFn.name+", Start: "+start+", End: "+end);setTimeout(function(){for(var i=start;i<end;i+=4){res=processFn.call(self.pixelInfo(i),adjust,{r:self.pixel_data[i],g:self.pixel_data[i+1],b:self.pixel_data[i+2],a:self.pixel_data[i+3]});self.pixel_data[i]=res.r;self.pixel_data[i+1]=res.g;self.pixel_data[i+2]=res.b;self.pixel_data[i+3]=res.a;break;}
block_finished(bnum);},0);},blocks_done=0,block_finished=function(bnum){console.log("Block #"+bnum+" finished! Filter: "+processFn.name);blocks_done++;if(blocks_done==Caman.renderBlocks){console.log("Filter "+processFn.name+" finished!");Caman.trigger("processComplete",{id:self.canvas_id,completed:processFn.name});self.processNext();}};for(var j=0;j<Caman.renderBlocks;j++){var start=j*blockN,end=start+((j==Caman.renderBlocks-1)?lastBlockN:blockN);render_block(j,start,end);}};Caman.manip.process=function(adjust,processFn){this.renderQueue.push({adjust:adjust,processFn:processFn});};Caman.manip.processNext=function(finishedFn){if(typeof finishedFn==="function"){this.finishedFn=finishedFn;}
if(this.renderQueue.length===0){Caman.trigger("renderFinished",{id:this.canvas_id});if(typeof this.finishedFn==="function"){this.finishedFn.call(this);}
return;}
var next=this.renderQueue.shift();this.executeFilter(next.adjust,next.processFn);};window.Caman=Caman;(function(Caman){Caman.manip.brightness=function(adjust){adjust=Math.floor(255*(adjust/100));return this.process(adjust,function brightness(adjust,rgba){rgba.r+=adjust;rgba.g+=adjust;rgba.b+=adjust;return rgba;});};Caman.manip.saturation=function(adjust){var chan,max,diff;adjust*=-1;return this.process(adjust,function saturation(adjust,rgba){max=Math.max(rgba.r,rgba.g,rgba.b);for(chan in rgba){if(rgba.hasOwnProperty(chan)){if(rgba[chan]===max||chan==="a"){continue;}
diff=max-rgba[chan];rgba[chan]+=Math.ceil(diff*(adjust/100));}}
return rgba;});};Caman.manip.greyscale=function(){return this.process({},function greyscale(adjust,rgba){var avg=0.3*rgba.r+0.59*rgba.g+0.11*rgba.b;rgba.r=avg;rgba.g=avg;rgba.b=avg;return rgba;});};Caman.manip.contrast=function(adjust){adjust=Math.pow((100+adjust)/100,2);return this.process(adjust,function contrast(adjust,rgba){var chan;for(chan in rgba){if(rgba.hasOwnProperty(chan)){if(chan==='a'){continue;}
rgba[chan]/=255;rgba[chan]-=0.5;rgba[chan]*=adjust;rgba[chan]+=0.5;rgba[chan]*=255;if(rgba[chan]>255){rgba[chan]=255;}else if(rgba[chan]<0){rgba[chan]=0;}}}
return rgba;});};Caman.manip.hue=function(adjust){var hsv,h;return this.process(adjust,function hue(adjust,rgba){hsv=Caman.rgb_to_hsv(rgba.r,rgba.g,rgba.b);h=hsv.h*100;h+=Math.abs(adjust);h=h%100;h/=100;hsv.h=h;rgb=Caman.hsv_to_rgb(hsv.h,hsv.s,hsv.v);return{r:rgb.r,g:rgb.g,b:rgb.b,a:rgba.a};});};Caman.manip.colorize=function(){var diff,rgb,level;if(arguments.length===2){rgb=Caman.hex_to_rgb(arguments[0]);level=arguments[1];}else if(arguments.length===4){rgb={r:arguments[0],g:arguments[1],b:arguments[2]};level=arguments[3];}
return this.process([level,rgb],function colorize(adjust,rgba){rgba.r-=(rgba.r-adjust[1].r)*(adjust[0]/100);rgba.g-=(rgba.g-adjust[1].g)*(adjust[0]/100);rgba.b-=(rgba.b-adjust[1].b)*(adjust[0]/100);return rgba;});};Caman.manip.invert=function(){return this.process({},function invert(adjust,rgba){rgba.r=255-rgba.r;rgba.g=255-rgba.g;rgba.b=255-rgba.b;return rgba;});};Caman.manip.sepia=function(adjust){if(adjust===undefined){adjust=100;}
adjust=(adjust/100);return this.process(adjust,function sepia(adjust,rgba){rgba.r=Math.min(255,(rgba.r*(1-(.607*adjust)))+(rgba.g*(.769*adjust))+(rgba.b*(.189*adjust)));rgba.g=Math.min(255,(rgba.r*(.349*adjust))+(rgba.g*(1-(.314*adjust)))+(rgba.b*(.168*adjust)));rgba.b=Math.min(255,(rgba.r*(.272*adjust))+(rgba.g*(.534*adjust))+(rgba.b*(1-(.869*adjust))));return rgba;});};Caman.manip.gamma=function(adjust){return this.process(adjust,function gamma(adjust,rgba){rgba.r=Math.pow(rgba.r/255,adjust)*255;rgba.g=Math.pow(rgba.g/255,adjust)*255;rgba.b=Math.pow(rgba.b/255,adjust)*255;return rgba;});};Caman.manip.noise=function(adjust){adjust=Math.abs(adjust)*2.55;return this.process(adjust,function noise(adjust,rgba){var rand=Caman.randomRange(adjust*-1,adjust);rgba.r+=rand;rgba.g+=rand;rgba.b+=rand;return rgba;});};Caman.manip.clip=function(adjust){adjust=Math.abs(adjust)*2.55;return this.process(adjust,function clip(adjust,rgba){if(rgba.r>255-adjust){rgba.r=255;}else if(rgba.r<adjust){rgba.r=0;}
if(rgba.g>255-adjust){rgba.g=255;}else if(rgba.g<adjust){rgba.g=0;}
if(rgba.b>255-adjust){rgba.b=255;}else if(rgba.b<adjust){rgba.b=0;}
return rgba;});};Caman.manip.channels=function(options){if(typeof(options)!=='object'){return;}
for(var chan in options){if(options.hasOwnProperty(chan)){if(options[chan]==0){delete options[chan];continue;}
options[chan]=options[chan]/100;}}
if(options.length===0){return;}
return this.process(options,function channels(options,rgba){if(options.red){if(options.red>0){rgba.r=rgba.r+((255-rgba.r)*options.red);}else{rgba.r=rgba.r-(rgba.r*Math.abs(options.red));}}
if(options.green){if(options.green>0){rgba.g=rgba.g+((255-rgba.g)*options.green);}else{rgba.g=rgba.g-(rgba.g*Math.abs(options.green));}}
if(options.blue){if(options.blue>0){rgba.b=rgba.b+((255-rgba.b)*options.blue);}else{rgba.b=rgba.b-(rgba.b*Math.abs(options.blue));}}
return rgba;});};}(Caman));}());